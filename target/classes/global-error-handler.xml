<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<error-handler name="global-error-handler">
		<on-error-propagate type="APIKIT:BAD_REQUEST"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="be22ec15-d722-4c04-98ba-41754e7d21e9">
			<set-variable value="#[400]"
				doc:name="Set HTTP Status - 400"
				doc:id="73841b1d-72da-4057-b28e-452b2f9b099f"
				variableName="httpStatus" />
			<set-variable value='Bad request'
				doc:name="set Error Message"
				doc:id="ab056277-7355-4b36-b623-2bdcd8045d06"
				variableName="errorMessage" />
			<set-variable value='#[error.description default ""]'
				doc:name="Set Error Description"
				doc:id="f108b364-3f42-4b36-b3bf-cd4c7cec7beb"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="233634ff-64c2-4b2f-9b19-8f68b466a996"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:METHOD_NOT_ALLOWED" enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="e3f80933-136b-4452-88fb-f21c437d0a89">
			<set-variable value="#[405]"
				doc:name="Set HTTP Status - 405"
				doc:id="393bf220-b778-4466-afc4-716cd72abe26"
				variableName="httpStatus" />
			<set-variable value='Method Not Allowed'
				doc:name="Set Error Message"
				doc:id="299fc43c-a7e9-49b5-a02c-4a0d6f04f325"
				variableName="errorMessage" />
			<set-variable
				value="The method specified in the request is not allowed for this resource"
				doc:name="Set Error Description"
				doc:id="397ab728-0336-497a-95ba-47b1a0f077b2"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="a3a7b8bc-352d-4432-b956-999484d7ff04"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_ACCEPTABLE"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="1808e435-7cc8-40b3-a1e6-ec7bf8470da0">
			<set-variable value="#[406]"
				doc:name="Set HTTP Status - 406"
				doc:id="c0eb1b60-a994-4932-9308-bf62dad7b341"
				variableName="httpStatus" />
			<set-variable value="Not Acceptable"
				doc:name="Set Error Message"
				doc:id="6c10d7d4-cf4c-43be-878e-9aa316a6dc23"
				variableName="errorMessage" />
			<set-variable
				value="The resource identified by the request is not capable of generating response entities according to the request accept headers"
				doc:name="Set Error Description"
				doc:id="bc03bde7-f1e1-4866-ba7b-f03f0980286e"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="4c7f0717-ba3b-41f4-982f-0ae50901052a"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_FOUND"
			enableNotifications="true" logException="true"
			doc:name="On Error Propagate"
			doc:id="da19d09c-5ffa-4ab8-99f9-31b89e6a95de">
			<set-variable value="#[404]"
				doc:name="Set HTTP Status - 404"
				doc:id="cecbdefb-734c-4610-bda2-035400cb8dec"
				variableName="httpStatus" />
			<set-variable value="Not found"
				doc:name="Set Error Message"
				doc:id="ecfb7558-bdc7-4473-a8e2-4a2cb76f448e"
				variableName="errorMessage" />
			<set-variable
				value="The server has not found anything matching the Request-URI"
				doc:name="Set Error Description"
				doc:id="9fd1a080-5eda-4d4a-b6c7-ee93dff3416a"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="8cde5d67-ba4e-4128-82f0-7ad4f2a6a55e"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate
			type="APIKIT:UNSUPPORTED_MEDIA_TYPE" enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="4d0eae4f-0336-4c91-90bb-40acad6a0b1f">
			<set-variable value="#[415]"
				doc:name="Set HTTP Status - 415"
				doc:id="b53f524c-abda-41cb-a8fe-8fff650d2460"
				variableName="httpStatus" />
			<set-variable value="Unsupported media type"
				doc:name="Set Error Message"
				doc:id="74f55c54-4628-4895-bff9-ebd2a242188d"
				variableName="errorMessage" />
			<set-variable
				value="The server is refusing to service the request because the entity of the request is in a format not supported by the requested resource for the requested method"
				doc:name="Set Error Description"
				doc:id="d886a8ad-4716-4730-af7b-1ae7e390b4ef"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="64289c36-8be2-457e-820b-0a2fa3855245"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate type="APIKIT:NOT_IMPLEMENTED">
			<set-variable value="#[501]"
				doc:name="Set HTTP Status - 501"
				doc:id="c9d964dd-8014-45c6-819d-4fb51812d936"
				variableName="httpStatus" />
			<set-variable value="Not Implemented"
				doc:name="Set Error Message"
				doc:id="3ff2b644-e75a-46bd-bb01-90bf96246680"
				variableName="errorMessage" />
			<set-variable
				value="The requested resource is not implemented"
				doc:name="Set Error Description"
				doc:id="35ef49d8-9cfb-48ef-9d68-eef0260b0d0a"
				variableName="errorDescription" />
			<ee:transform
				doc:name="global-prepare-error-response-sub-flow">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{message: "Not Implemented"}]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="httpStatus">501</ee:set-variable>
				</ee:variables>
			</ee:transform>
		</on-error-propagate>
		<on-error-propagate enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="c870504b-8913-4557-902a-b4ce987dd7a5" type="JMS:PUBLISHING">
			<set-variable value="#[400]"
				doc:name="Set HTTP Status - 400"
				doc:id="3bbff45e-55e2-4ee4-8c7d-b3ce369357dd"
				variableName="httpStatus" />
			<set-variable value="Bad Request"
				doc:name="Set Error Message"
				doc:id="c093c8ed-6d40-4803-8356-c2957445ccc7"
				variableName="errorMessage" />
			<set-variable
				value="#[error.errorMessage]"
				doc:name="Set Error Description"
				doc:id="a6902411-78aa-48da-b1fa-bf8547e0b148"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="bd5bb208-baca-4706-b2f4-6e1ca655ef52"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
		<on-error-propagate enableNotifications="true"
			logException="true" doc:name="On Error Propagate"
			doc:id="fd656c75-ce79-460a-aa76-3660f3027579"
			type="ANY">
			<set-variable value="#[500]"
				doc:name="Set HTTP Status - 500"
				doc:id="725bef40-a097-40dd-bd33-79a1fedfa2e4"
				variableName="httpStatus" />
			<set-variable value="Internal Server Error"
				doc:name="Set Error Message"
				doc:id="322f3a20-3cfa-4aba-9244-86781b9a9877"
				variableName="errorMessage" />
			<set-variable
				value="#[error.errorMessage]"
				doc:name="Set Error Description"
				doc:id="11067735-2e9d-4062-a6f2-0f2df28eb5cf"
				variableName="errorDescription" />
			<flow-ref doc:name="global-prepare-error-response-sub-flow"
				doc:id="b50d9dbb-919e-4108-bf36-60ac2e5bf56f"
				name="global-prepare-error-response-sub-flow" />
		</on-error-propagate>
	</error-handler>
	<sub-flow name="global-prepare-error-response-sub-flow"
		doc:id="21b07a09-2c03-4cce-9e7f-111af7c45db2">
		<ee:transform doc:name="Init Variables"
			doc:id="2e56e715-098d-4a65-814e-5576f06265ce">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="errorRaised"><![CDATA[%dw 2.0
output application/java
---
true]]></ee:set-variable>
				<ee:set-variable variableName="errorDescription"><![CDATA[%dw 2.0
output application/java
---
if(vars.errorDescription?) 
	vars.errorDescription 
else 
	error.exception.detailMessage]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Error Response"
			doc:id="d64afdf2-4460-48ef-b699-785342fc9a66">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json encoding="UTF-8", skipNullOn="everywhere"
---
{
	code : vars.httpStatus,
	message : if(vars.errorMessage != null) vars.errorMessage else (error.errorType.identifier),
	description: if(vars.errorDescription != null) vars.errorDescription else error.description,
	dateTime : now() as String { format: "yyyy-MM-dd'T'HH:mm:ss'Z'" },
	correlationId: vars.correlationId,
	transactionId : vars.transactionId
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="ERROR" doc:name="Error Logger"
			doc:id="41c15ef2-e4e9-404e-b9d8-184c888c6ff9"
			message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;	"correlationId": vars.correlationId,&#10;	"transactionId": vars.transactionId,&#10;	"errorCode": vars.httpStatus,&#10;	"errorMessage": error.errorType.identifier default "",&#10;	"errorDescription": error.description default ""&#10;}]' />
	</sub-flow>
</mule>
